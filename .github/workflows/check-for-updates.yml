name: Check for TelegramBots Updates

permissions:
  contents: write
  pull-requests: write

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  check-updates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Get latest TelegramBots version
        id: get_version
        run: |
          # Install xmllint, which is required for parsing XML
          sudo apt-get update
          sudo apt-get install -y libxml2-utils

          # Fetch maven-metadata.xml, which is the source of truth for versions.
          # This is more reliable than the search API.
          METADATA_URL="https://repo1.maven.org/maven2/org/telegram/telegrambots-meta/maven-metadata.xml"
          XML_RESPONSE=$(curl -s "$METADATA_URL")
          
          # Use xmllint (a standard XML tool) to parse the <release> tag.
          LATEST_VERSION=$(echo "$XML_RESPONSE" | xmllint --xpath "string(/metadata/versioning/release)" -)
          
          if [ -z "$LATEST_VERSION" ]; then
            echo "Error: Could not extract latest version from $METADATA_URL"
            echo "Response: $XML_RESPONSE"
            exit 1
          fi
          echo "Latest version on Maven Central: $LATEST_VERSION"
          echo "LATEST_VERSION=$LATEST_VERSION" >> $GITHUB_OUTPUT

      - name: Get current version from gradle.properties
        id: get_current_version
        run: |
          CURRENT_VERSION=$(grep 'telegrambotsVersion' gradle.properties | cut -d'=' -f2)
          echo "Current version in gradle.properties: $CURRENT_VERSION"
          echo "CURRENT_VERSION=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: Compare versions and update if needed
        if: steps.get_version.outputs.LATEST_VERSION != steps.get_current_version.outputs.CURRENT_VERSION
        run: |
          echo "New version found! Updating gradle.properties..."
          sed -i "s/telegrambotsVersion=.*/telegrambotsVersion=${{ steps.get_version.outputs.LATEST_VERSION }}/" gradle.properties
          echo "gradle.properties updated."
          
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          PR_BRANCH_NAME="bot/bump-telegrambots-to-${{ steps.get_version.outputs.LATEST_VERSION }}"
          git checkout -b $PR_BRANCH_NAME
          
          git add gradle.properties
          git commit -m "build: Bump telegrambots version to ${{ steps.get_version.outputs.LATEST_VERSION }}"
          git push origin $PR_BRANCH_NAME
          
          gh pr create --title "build: Bump telegrambots version to ${{ steps.get_version.outputs.LATEST_VERSION }}" --body "Automated PR to update the TelegramBots dependency." --base main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: No update needed
        if: steps.get_version.outputs.LATEST_VERSION == steps.get_current_version.outputs.CURRENT_VERSION
        run: echo "TelegramBots version is up to date."
