name: Check for TelegramBots Updates

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  check-updates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Get latest TelegramBots version
        id: get_version
        run: |
          # Retry up to 5 times if the response is invalid
          for attempt in {1..5}; do
            JSON_RESPONSE=$(curl -s "https://search.maven.org/solrsearch/select?q=g:%22org.telegram%22+AND+a:%22telegrambots%22&meta=gav&rows=1&wt=json")
            if echo "$JSON_RESPONSE" | jq -e . >/dev/null 2>&1; then
              LATEST_VERSION=$(echo "$JSON_RESPONSE" | jq -r '.response.docs[0].v')
              break
            else
              echo "Attempt $attempt: Invalid JSON response from Maven Central, retrying..."
              sleep 5
            fi
          done
          if [ -z "$LATEST_VERSION" ] || [ "$LATEST_VERSION" == "null" ]; then
            echo "Error: Could not extract latest version from Maven Central response"
            echo "$JSON_RESPONSE"
            exit 1
          fi
          echo "Latest version on Maven Central: $LATEST_VERSION"
          echo "LATEST_VERSION=$LATEST_VERSION" >> $GITHUB_OUTPUT

      - name: Get current version from gradle.properties
        id: get_current_version
        run: |
          CURRENT_VERSION=$(grep 'telegrambotsVersion' gradle.properties | cut -d'=' -f2)
          echo "Current version in gradle.properties: $CURRENT_VERSION"
          echo "CURRENT_VERSION=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: Compare versions and update if needed
        if: steps.get_version.outputs.LATEST_VERSION != steps.get_current_version.outputs.CURRENT_VERSION
        run: |
          echo "New version found! Updating gradle.properties..."
          sed -i "s/telegrambotsVersion=.*/telegrambotsVersion=${{ steps.get_version.outputs.LATEST_VERSION }}/" gradle.properties
          echo "gradle.properties updated."
          
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          PR_BRANCH_NAME="bot/bump-telegrambots-to-${{ steps.get_version.outputs.LATEST_VERSION }}"
          git checkout -b $PR_BRANCH_NAME
          
          git add gradle.properties
          git commit -m "build: Bump telegrambots version to ${{ steps.get_version.outputs.LATEST_VERSION }}"
          git push origin $PR_BRANCH_NAME
          
          gh pr create --title "build: Bump telegrambots version to ${{ steps.get_version.outputs.LATEST_VERSION }}" --body "Automated PR to update the TelegramBots dependency." --base main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: No update needed
        if: steps.get_version.outputs.LATEST_VERSION == steps.get_current_version.outputs.CURRENT_VERSION
        run: echo "TelegramBots version is up to date."
